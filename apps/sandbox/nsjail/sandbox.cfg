# NSJail Configuration for Python Code Sandbox
#
# Python 3.10-slim 이미지용 설정
# 참고: https://github.com/google/nsjail

name: "python_sandbox"
description: "Secure Python code execution sandbox"

# =====================================
# 기본 실행 모드
# =====================================
mode: ONCE

# =====================================
# 시간 제한
# =====================================
time_limit: 10
rlimit_cpu: 10

# =====================================
# 메모리 제한
# =====================================
rlimit_as: 256
rlimit_fsize: 10
rlimit_nofile: 32

# =====================================
# 사용자/그룹 (Nobody)
# =====================================
uidmap {
    inside_id: "65534"
    outside_id: "65534"
    count: 1
}

gidmap {
    inside_id: "65534"
    outside_id: "65534"
    count: 1
}

# =====================================
# 네임스페이스 격리
# =====================================
clone_newnet: true
clone_newuser: true
clone_newns: true
clone_newpid: true
clone_newipc: true
clone_newuts: true
clone_newcgroup: true

# =====================================
# 파일시스템 마운트 (Read-Only)
# =====================================

# /usr 전체 (Python, 라이브러리 등 포함)
mount {
    src: "/usr"
    dst: "/usr"
    is_bind: true
    rw: false
}

# /lib (시스템 라이브러리)
mount {
    src: "/lib"
    dst: "/lib"
    is_bind: true
    rw: false
    mandatory: false
}

mount {
    src: "/lib64"
    dst: "/lib64"
    is_bind: true
    rw: false
    mandatory: false
}

# /etc (일부 설정 파일 필요)
mount {
    src: "/etc/passwd"
    dst: "/etc/passwd"
    is_bind: true
    rw: false
    mandatory: false
}

mount {
    src: "/etc/group"
    dst: "/etc/group"
    is_bind: true
    rw: false
    mandatory: false
}

# 필수 디바이스
mount {
    dst: "/dev"
    fstype: "tmpfs"
    rw: true
}

mount {
    src: "/dev/null"
    dst: "/dev/null"
    is_bind: true
    rw: true
}

mount {
    src: "/dev/urandom"
    dst: "/dev/urandom"
    is_bind: true
    rw: false
}

mount {
    src: "/dev/zero"
    dst: "/dev/zero"
    is_bind: true
    rw: false
}

# /proc 마운트
mount {
    dst: "/proc"
    fstype: "proc"
    rw: false
}

# /tmp (쓰기 가능)
mount {
    dst: "/tmp"
    fstype: "tmpfs"
    rw: true
    options: "size=10m"
}

# /tmp/sandbox (호스트의 스크립트 파일 접근용)
mount {
    src: "/tmp/sandbox"
    dst: "/tmp/sandbox"
    is_bind: true
    rw: false
}

# /app 디렉토리 (wrapper에서 bindmount_ro로 마운트되므로 제거)
# 스크립트는 /tmp/sandbox에 생성되고 /app/run.py로 바인드 마운트됨

# =====================================
# 환경 변수
# =====================================
envar: "PATH=/usr/local/bin:/usr/bin:/bin"
envar: "PYTHONIOENCODING=utf-8"
envar: "LANG=C.UTF-8"
envar: "HOME=/tmp"

# =====================================
# 작업 디렉토리
# =====================================
cwd: "/tmp"

# =====================================
# 로깅
# =====================================
log_level: 2
keep_env: false
silent: false

# =====================================
# 실행할 바이너리 (기본값 - CLI에서 오버라이드 가능)
# =====================================
exec_bin {
    path: "/usr/local/bin/python3"
    arg0: "python3"
    arg: "/app/run.py"
}
