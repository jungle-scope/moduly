# --- 1. 기본 포트 및 ACL 정의 ---
acl SSL_ports port 443
acl Safe_ports port 80      # http
acl Safe_ports port 443     # https
acl CONNECT method CONNECT

# [핵심] PID 파일을 생성하지 않음 (권한 에러 원천 차단)
pid_filename none

# --- 2. 접근 거부 규칙 (기본 보안) ---
# SSL 포트가 아닌 곳으로의 CONNECT 시도 차단
http_access deny CONNECT !SSL_ports

# 안전하지 않은 포트로의 접근 차단
http_access deny !Safe_ports

# --- 3. 내부망 및 AWS 메타데이터 차단 (핵심 보안) ---
# [중요] AWS 메타데이터 (가장 위험)
acl aws_metadata dst 169.254.169.254/32

# [중요] 사설 IP 대역 (내부망 해킹 방지)
acl private_net dst 10.0.0.0/8
acl private_net dst 172.16.0.0/12
acl private_net dst 192.168.0.0/16
# [추가] Localhost 접근 차단 (Loopback 공격 방지)
acl loopback dst 127.0.0.0/8
acl loopback dst ::1/128

# 차단 규칙 적용
http_access deny aws_metadata
http_access deny private_net
http_access deny loopback

# --- 4. 최종 허용 ---
# 위에서 차단되지 않은 나머지(외부 인터넷)는 허용
http_access allow all

# --- 5. 포트 및 네트워크 설정 ---
http_port 3128
# IPv6 끄기 (ECS 네트워크 지연 방지 및 호환성)
dns_v4_first on

# --- 6. Docker/ECS용 로그 설정 (필수) ---
# 로그를 파일이 아닌 표준 출력(stdio)으로 보냄 -> CloudWatch에서 확인 가능
logfile_rotate 0
access_log stdio:/var/log/squid/access.log
cache_log stdio:/var/log/squid/cache.log

# --- 7. 기타 최적화 ---
# 프록시 사용 사실 숨기기 (선택 사항)
forwarded_for delete
via off

# 컨테이너 종료 시 대기 시간 단축 (배포 속도 향상)
shutdown_lifetime 1 seconds