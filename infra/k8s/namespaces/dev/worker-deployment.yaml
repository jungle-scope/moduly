# Worker Deployment for Dev Environment
# 
# 역할: 백그라운드 작업 처리 (비동기 task queue)
# 
# API Server와의 주요 차이점:
# 1. 실행 명령어: API는 uvicorn, Worker는 celery/python
# 2. 포트: API는 8000 포트 EXPOSE, Worker는 포트 없음
# 3. Service: API는 Service 있음, Worker는 Service 없음 (외부 접근 불필요)
# 4. Health Check: API는 HTTP health check, Worker는 없음
# 5. 리소스: Worker가 더 적은 CPU/메모리 (100m/128Mi vs 200m/256Mi)
# 6. Replicas: Worker는 1개, API는 2개 (default), dev는 모두 1개
# 
# Dev 환경 특성:
# - default의 Redis queue와 분리하기 위해 별도 DB 사용
# - Worker 개발/테스트를 위한 격리된 환경
# 
apiVersion: apps/v1
kind: Deployment
metadata:
  name: worker
  namespace: dev
  labels:
    app: worker
    environment: development
spec:
  replicas: 1
  selector:
    matchLabels:
      app: worker
  template:
    metadata:
      labels:
        app: worker
    spec:
      containers:
      - name: worker
        image: 912894834396.dkr.ecr.ap-northeast-2.amazonaws.com/moduly-workflow-engine:dev-latest
        
        env:
        - name: DB_HOST
          value: postgresql.default.svc.cluster.local
        - name: DB_PORT
          value: "5432"
        - name: DB_NAME
          value: moduly_dev  # dev 환경용 별도 DB
        - name: DB_USER
          value: postgres
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: app-secrets
              key: DB_PASSWORD
        - name: REDIS_HOST
          value: redis-master.default.svc.cluster.local
        - name: REDIS_PORT
          value: "6379"
        - name: REDIS_PASSWORD
          valueFrom:
            secretKeyRef:
              name: app-secrets
              key: REDIS_PASSWORD
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 200m
            memory: 256Mi
---
apiVersion: v1
kind: Service
metadata:
  name: worker-service
  namespace: dev
spec:
  selector:
    app: worker
  ports:
  - protocol: TCP
    port: 8000
    targetPort: 8000
  type: ClusterIP
