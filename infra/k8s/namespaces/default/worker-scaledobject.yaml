# KEDA ScaledObject for Worker
# 
# KEDA를 사용한 Celery Worker Auto-scaling
# - Redis List 길이를 모니터링하여 자동 스케일링
# - Prometheus Adapter 대신 KEDA Redis Scaler 사용
#
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: worker-scaledobject
  namespace: default
spec:
  scaleTargetRef:
    name: worker  # worker deployment
  minReplicaCount: 4
  maxReplicaCount: 30  # 최대 30개까지 확장
  pollingInterval: 5   # 5초마다 기민하게 체크
  cooldownPeriod: 300  # 스케일 다운 후 5분 대기 (기존 HPA와 동일)
  triggers:
  - type: redis
    metadata:
      # Redis 접속 정보
      address: redis-master.default.svc.cluster.local:6379
      # Celery workflow 큐 모니터링 (Redis List 타입)
      listName: workflow  # Celery 큐 이름
      listLength: "2"     # 큐 길이 2개당 파드 1개 추가 (매우 공격적)
      databaseIndex: "0"  # Redis DB 0 (브로커)
      # 활성화 임계값 (큐 길이 0이면 minReplicas로 유지)
      activationListLength: "0"
    authenticationRef:
      name: redis-auth  # Secret 참조 (비밀번호)
  advanced:
    horizontalPodAutoscalerConfig:
      behavior:
        scaleDown:
          stabilizationWindowSeconds: 300
          policies:
          - type: Percent
            value: 50
            periodSeconds: 60
        scaleUp:
          stabilizationWindowSeconds: 0
          policies:
          - type: Percent
            value: 100
            periodSeconds: 30
          - type: Pods
            value: 4
            periodSeconds: 30
          selectPolicy: Max
---
# KEDA TriggerAuthentication for Redis
# Redis 비밀번호를 Secret에서 가져오기
apiVersion: keda.sh/v1alpha1
kind: TriggerAuthentication
metadata:
  name: redis-auth
  namespace: default
spec:
  secretTargetRef:
  - parameter: password
    name: app-secrets  # 기존 Secret 사용
    key: REDIS_PASSWORD
