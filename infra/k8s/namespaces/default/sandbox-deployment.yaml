# Moduly Sandbox Deployment
#
# NSJail 기반 Python 코드 실행 샌드박스
# - Fair Scheduler (MLFQ + Round-Robin + Aging)
# - SJF 기반 우선순위 자동 결정
# - EMA 기반 동적 워커 스케일링
#
# 보안:
# - NSJail을 통한 프로세스 격리 (Linux namespace, cgroups)
# - 네트워크 기본 차단 (enable_network 옵션으로 제어)
# - 비root 사용자 실행
# - 리소스 제한 (CPU, 메모리, 시간)
#
# 주의: NSJail은 privileged 모드 또는 특정 capabilities 필요
#
apiVersion: apps/v1
kind: Deployment
metadata:
  name: sandbox
  labels:
    app: sandbox
spec:
  replicas: 2
  selector:
    matchLabels:
      app: sandbox
  template:
    metadata:
      labels:
        app: sandbox
    spec:
      containers:
        - name: sandbox
          image: 912894834396.dkr.ecr.ap-northeast-2.amazonaws.com/moduly-sandbox:latest
          ports:
            - containerPort: 8194
              name: http
          env:
            # ===== 기본 설정 =====
            - name: SANDBOX_DEV_MODE
              value: "false" # 프로덕션: NSJail 사용
            - name: TZ
              value: "Asia/Seoul"

            # ===== 워커 풀 설정 =====
            - name: SANDBOX_MIN_WORKERS
              value: "2"
            - name: SANDBOX_MAX_WORKERS
              value: "8"
            - name: SANDBOX_WORKER_IDLE_TIMEOUT
              value: "30"

            # ===== 동적 스케일링 (EMA) =====
            - name: SANDBOX_SCALING_INTERVAL
              value: "1"
            - name: SANDBOX_EMA_ALPHA
              value: "0.2"
            - name: SANDBOX_TARGET_RPS_PER_WORKER
              value: "2.0"
            - name: SANDBOX_SCALE_DOWN_COOLDOWN
              value: "30"
            - name: SANDBOX_SCALE_DOWN_IDLE_TIME
              value: "30"

            # ===== 실행 제한 =====
            - name: SANDBOX_DEFAULT_TIMEOUT
              value: "10"
            - name: SANDBOX_MAX_TIMEOUT
              value: "60"
            - name: SANDBOX_MAX_MEMORY_MB
              value: "128"

            # ===== 큐 설정 =====
            - name: SANDBOX_MAX_QUEUE_SIZE
              value: "1000"

            # ===== Fair Scheduler =====
            - name: SANDBOX_MAX_PER_TENANT
              value: "3"
            - name: SANDBOX_AGING_INTERVAL
              value: "5"
            - name: SANDBOX_AGING_THRESHOLD_LOW
              value: "15" # LOW → NORMAL 승급 기준 (초)
            - name: SANDBOX_AGING_THRESHOLD_NORMAL
              value: "30" # NORMAL → HIGH 승급 기준 (초)
            - name: SANDBOX_QUEUE_CLEANUP_INTERVAL
              value: "300" # 빈 큐 정리 주기 (초)
            - name: SANDBOX_QUEUE_IDLE_TIMEOUT
              value: "600" # 빈 큐 삭제 기준 (초)

          resources:
            requests:
              cpu: 500m
              memory: 512Mi
            limits:
              cpu: 2000m
              memory: 2Gi
          # NSJail 실행을 위한 보안 설정
          securityContext:
            privileged: true # NSJail namespace 생성을 위해 필요
          livenessProbe:
            httpGet:
              path: /v1/sandbox/health
              port: 8194
            initialDelaySeconds: 30
            periodSeconds: 10
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /v1/sandbox/health
              port: 8194
            initialDelaySeconds: 10
            periodSeconds: 5
            failureThreshold: 3
---
apiVersion: v1
kind: Service
metadata:
  name: sandbox-service
spec:
  selector:
    app: sandbox
  ports:
    - port: 8194
      targetPort: 8194
      name: http
  type: ClusterIP
---
# NetworkPolicy: Sandbox Pod의 외부 통신 제한
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: sandbox-network-policy
spec:
  podSelector:
    matchLabels:
      app: sandbox
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
        - podSelector: {}
      ports:
        - protocol: TCP
          port: 8194
  egress:
    - ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
