name: Deploy Backend (Develop)

on:
  push:
    branches:
      - develop   # â­ develop ë¸Œëœì¹˜ í‘¸ì‹œ ì‹œ ì‘ë™
    paths:
      - 'apps/server/**' # â­ ë°±ì—”ë“œ ì½”ë“œ ë³€ê²½ ì‹œì—ë§Œ ì‘ë™

  workflow_dispatch:
    inputs:
      service_name:
        description: 'ë°°í¬í•  ECS ì„œë¹„ìŠ¤ ì´ë¦„'
        required: true
        # ğŸ‘‡ [ì¤‘ìš”] ì‹¤ìˆ˜ ë°©ì§€ë¥¼ ìœ„í•´ "í…ŒìŠ¤íŠ¸ìš© ì„œë¹„ìŠ¤ ì´ë¦„"ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ì¶”ì²œ
        default: 'moduly-backend-task-def-service-rt8cb5dx' 
      branch_to_deploy:
        description: 'ë°°í¬í•  ë¸Œëœì¹˜ (ë¹„ì›Œë‘ë©´ í˜„ì¬ ë¸Œëœì¹˜ ì‚¬ìš©)'
        required: false

jobs:
  deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest

    steps:
    # 1. ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
    - name: Checkout
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.branch_to_deploy || github.ref }}

    # 2. AWS ë¡œê·¸ì¸
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    # 3. ECR ë¡œê·¸ì¸
    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    # 4. ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ (sha íƒœê·¸ ì‚¬ìš©)
    - name: Build, tag, and push image to Amazon ECR
      id: build-image
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        docker build -f ./apps/server/Dockerfile -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
        echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

    # 5. [ì¤‘ìš”] ê¸°ì¡´ íƒœìŠ¤í¬ ì •ì˜ íŒŒì¼ ë‚´ë ¤ë°›ê¸°
    # (ECSì— í˜„ì¬ ì„¤ì •ëœ json íŒŒì¼ì„ ê°€ì ¸ì˜µë‹ˆë‹¤)
    - name: Download task definition
      run: |
        aws ecs describe-task-definition \
          --task-definition moduly-backend-task-def \
          --query 'taskDefinition | {family: family, taskRoleArn: taskRoleArn, executionRoleArn: executionRoleArn, networkMode: networkMode, containerDefinitions: containerDefinitions, volumes: volumes, placementConstraints: placementConstraints, requiresCompatibilities: requiresCompatibilities, cpu: cpu, memory: memory}' \
          > task-definition.json

    # 6. [ì¤‘ìš”] íƒœìŠ¤í¬ ì •ì˜ì— ìƒˆ ì´ë¯¸ì§€ ê°ˆì•„ë¼ìš°ê¸°
    # (ë‹¤ìš´ë°›ì€ json íŒŒì¼ ì•ˆì˜ 'image' ë¶€ë¶„ì„ ë°©ê¸ˆ ë¹Œë“œí•œ ê±¸ë¡œ ë°”ê¿‰ë‹ˆë‹¤)
    - name: Fill in the new image ID in the Amazon ECS task definition
      id: task-def
      uses: aws-actions/amazon-ecs-render-task-definition@v1
      with:
        task-definition: task-definition.json
        container-name: moduly-backend-container # â­ ì‚¬ìš©ìë‹˜ì˜ ì»¨í…Œì´ë„ˆ ì´ë¦„ í™•ì¸ í•„ìš”!
        image: ${{ steps.build-image.outputs.image }}

    # 7. ECS ì„œë¹„ìŠ¤ ë°°í¬ (ì´ë¯¸ì§€ê°€ êµì²´ëœ ìƒˆ íƒœìŠ¤í¬ ì •ì˜ë¡œ ì—…ë°ì´íŠ¸)
    - name: Deploy Amazon ECS task definition
      uses: aws-actions/amazon-ecs-deploy-task-definition@v1
      with:
        task-definition: ${{ steps.task-def.outputs.task-definition }}
        # ğŸ‘‡ ì…ë ¥ê°’ì´ ìˆìœ¼ë©´(ìˆ˜ë™) ê·¸ê±¸ ì“°ê³ , ì—†ìœ¼ë©´(ìë™) ê¸°ë³¸ ì„œë¹„ìŠ¤ ì‚¬ìš©
        service: ${{ inputs.service_name || 'moduly-backend-api-svc' }}
        cluster: ${{ secrets.ECS_CLUSTER }}
        wait-for-service-stability: true